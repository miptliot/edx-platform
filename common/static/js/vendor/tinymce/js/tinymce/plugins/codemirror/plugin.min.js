tinymce.PluginManager.requireLangPack("codemirror"),tinymce.PluginManager.add("codemirror",function(d,l){function e(){var c;d.focus(),d.selection.collapse(!0),d.selection.setContent('<span class="CmCaReT" style="display:none">&#0;</span>');var e=tinyMCE.baseURL.indexOf("/static/");c=0<e?tinyMCE.baseURL.substring(0,e):window.location.origin;var t="?CodeMirrorPath="+d.settings.codemirror.path+"&ParentOrigin="+window.location.origin,n=document.createElement("a");n.href=l;var o=n.pathname.split("/");1<o.length&&"static"!==o[1]&&(o[1]="static"),l=window.location.origin+o.join("/");var s=d.windowManager.open({title:"HTML source code",url:l+"/source.html"+t,width:800,height:550,resizable:!0,maximizable:!0,buttons:[{text:"OK",subtype:"primary",onclick:function(){r({type:"save"})}},{text:"Cancel",onclick:function(){r({type:"cancel"})}}]}),i=s.getEl().getElementsByTagName("iframe")[0].contentWindow,r=function(e){i.postMessage(e,c)},a=function(e){var t;if(c===e.origin)if("init"===e.data.type)t={content:d.getContent({source_view:!0})},d.fire("ShowCodeEditor",t),r({type:"init",content:t.content}),d.dom.remove(d.dom.select(".CmCaReT"));else if("setText"===e.data.type){t={content:e.data.text};var n=e.data.isDirty;d.fire("SaveCodeEditor",t),d.setContent(t.content);var o=d.dom.select("span#CmCaReT")[0];if(o)d.selection.scrollIntoView(o),d.selection.setCursorLocation(o,0),d.dom.remove(o);else{var i=d.getContent(),a=i.replace('<span id="CmCaReT"></span>',"");i!==a&&d.setContent(a)}d.isNotDirty=!n,n&&d.nodeChanged()}else"closeWindow"===e.data.type&&s.close()};s.on("close",function(){window.removeEventListener("message",a)}),window.addEventListener("message",a,!1)}d.addButton("code",{title:"Edit HTML",text:"HTML",icon:!1,onclick:e}),d.addMenuItem("code",{icon:"code",text:"Edit HTML",context:"tools",onclick:e})});